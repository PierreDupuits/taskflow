<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#1976d2">
<title>TaskFlow - Synchronis√©</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--p:#1976d2;--s:#dc004e;--ok:#4caf50;--warn:#ff9800;--err:#f44336;--dark:#1a1a1a;--light:#fff;--gray-l:#f5f5f5;--gray:#9e9e9e;--sh:0 2px 4px rgba(0,0,0,.1);--r:8px}
body{font-family:system-ui,-apple-system,sans-serif;background:var(--gray-l);color:var(--dark);transition:.3s}
body.dark{background:#121212;color:var(--light)}
body.dark .card,body.dark .filters-bar,body.dark .stat-card,body.dark .task-card,body.dark .modal-content,body.dark .kpi-card{background:#1e1e1e;color:var(--light)}
body.dark .kanban-column{background:rgba(30,30,30,.7)}

.app-header{background:var(--p);color:#fff;padding:1rem;box-shadow:var(--sh);position:sticky;top:0;z-index:1000}
.header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
.header-title{display:flex;align-items:center;gap:1rem}
.space-switcher{display:flex;gap:.5rem;background:rgba(255,255,255,.2);padding:.25rem;border-radius:var(--r)}
.space-btn{padding:.5rem 1rem;border:0;background:0;color:#fff;cursor:pointer;border-radius:6px;transition:.3s}
.space-btn.active{background:#fff;color:var(--p)}
.header-actions{display:flex;gap:1rem;align-items:center}
.icon-btn{background:0;border:0;color:#fff;cursor:pointer;padding:.5rem;border-radius:50%;transition:.3s}
.icon-btn:hover{background:rgba(255,255,255,.2)}
.icon-btn[data-action="refresh"]{transition:transform 0.3s}
.icon-btn[data-action="refresh"]:active{transform:rotate(180deg)}

.sync-indicator{display:inline-flex;align-items:center;gap:0.5rem;padding:0.25rem 0.75rem;background:rgba(255,255,255,0.2);border-radius:20px;font-size:0.875rem}
.sync-indicator.syncing{animation:pulse 2s infinite}
.sync-indicator.offline{background:rgba(255,100,100,0.3)}

.main-container{max-width:1400px;margin:2rem auto;padding:0 1rem}
.filters-bar{background:#fff;padding:1rem;border-radius:var(--r);box-shadow:var(--sh);margin-bottom:2rem;display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
.filter-group{display:flex;gap:.5rem;align-items:center}
select,input{padding:.5rem 1rem;border:1px solid #ddd;border-radius:6px;font-size:14px;transition:.3s}
select:focus,input:focus{outline:0;border-color:var(--p);box-shadow:0 0 0 3px rgba(25,118,210,.1)}

.stats-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-bottom:2rem}
.stat-card{background:#fff;padding:1.5rem;border-radius:var(--r);box-shadow:var(--sh);text-align:center;transition:transform .3s}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
.stat-value{font-size:2rem;font-weight:700;color:var(--p)}
.stat-label{color:var(--gray);margin-top:.5rem}

.kanban-board{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;margin-bottom:2rem}
.kanban-column{background:rgba(255,255,255,.7);border-radius:var(--r);padding:1rem;min-height:400px;position:relative;z-index:1}
.column-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:2px solid var(--gray-l)}
.column-title{font-weight:600;display:flex;align-items:center;gap:.5rem}
.column-count{background:var(--gray-l);color:var(--gray);padding:.25rem .5rem;border-radius:12px;font-size:.875rem}
.tasks-container{min-height:50px;padding:.5rem;transition:.3s}

.task-card{background:#fff;padding:1rem;border-radius:var(--r);box-shadow:var(--sh);margin-bottom:.75rem;cursor:grab;transition:.3s;position:relative;overflow:hidden;user-select:none}
.task-card:active{cursor:grabbing}
.task-card.dragging{opacity:0.5;pointer-events:none}
.task-card .delete-btn{position:absolute;top:.5rem;right:.5rem;background:var(--err);color:#fff;border:0;border-radius:50%;width:24px;height:24px;font-size:12px;cursor:pointer;opacity:0;transition:opacity .3s}
.task-card:hover .delete-btn{opacity:1}
.task-card.priority-high{border-left:4px solid var(--err)}
.task-card.priority-medium{border-left:4px solid var(--warn)}
.task-card.priority-low{border-left:4px solid var(--ok)}
.task-card.urgent{animation:pulse-border 2s infinite}
@keyframes pulse-border{0%{box-shadow:0 0 0 0 rgba(244,67,54,.7)}70%{box-shadow:0 0 0 6px rgba(244,67,54,0)}100%{box-shadow:0 0 0 0 rgba(244,67,54,0)}}
.week-badge{position:absolute;top:.5rem;right:2.5rem;background:var(--p);color:#fff;padding:.25rem .5rem;border-radius:12px;font-size:.75rem;font-weight:600}
.task-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:.5rem}
.task-title{font-weight:500;flex:1}
.task-category{font-size:.75rem;padding:.25rem .5rem;background:var(--gray-l);border-radius:12px;color:var(--gray)}
.task-meta{display:flex;gap:1rem;margin-top:.5rem;font-size:.875rem;color:var(--gray)}
.task-meta-item{display:flex;align-items:center;gap:.25rem}
.delegated-to{color:var(--p);font-weight:500}
.deadline-warning{color:var(--err);font-weight:500}

.fab{position:fixed;bottom:2rem;width:56px;height:56px;color:#fff;border:0;border-radius:50%;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:.3s;z-index:90;font-size:24px}
.fab:hover{transform:scale(1.1);box-shadow:0 6px 16px rgba(0,0,0,.2)}
.add-task-btn{background:var(--p);right:2rem}
.voice-btn{background:var(--s);right:6rem;font-size:20px}
.voice-btn.recording{animation:pulse 1.5s infinite;background:var(--err)}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center;padding:1rem}
.modal.active{display:flex}
.modal-content{background:#fff;padding:2rem;border-radius:var(--r);width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.modal-title{font-size:1.5rem;font-weight:600}
.close-btn{background:0;border:0;font-size:1.5rem;cursor:pointer;color:var(--gray);padding:.5rem}

.form-group{margin-bottom:1.5rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:500}
.form-input,.form-select,.form-textarea{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:6px;font-size:1rem;transition:.3s}
.form-textarea{min-height:100px;resize:vertical}
.form-actions{display:flex;gap:1rem;justify-content:flex-end;margin-top:2rem}
.btn{padding:.75rem 1.5rem;border:0;border-radius:6px;font-size:1rem;cursor:pointer;transition:.3s}
.btn-primary{background:var(--p);color:#fff}
.btn-primary:hover{background:#1565c0}
.btn-secondary{background:var(--gray-l);color:var(--dark)}
.btn-secondary:hover{background:#e0e0e0}

.notification{position:fixed;top:5rem;right:1rem;background:#fff;padding:1rem 1.5rem;border-radius:var(--r);box-shadow:0 4px 12px rgba(0,0,0,.15);transform:translateX(400px);transition:transform .3s;z-index:3000;max-width:300px}
.notification.show{transform:translateX(0)}
.notification.success{border-left:4px solid var(--ok)}
.notification.error{border-left:4px solid var(--err)}
.notification.warning{border-left:4px solid var(--warn)}

.kpi-period-selector{display:flex;gap:1rem;justify-content:center;margin-bottom:2rem}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-top:2rem}
.kpi-card{background:var(--gray-l);padding:1.5rem;border-radius:var(--r);text-align:center}
.kpi-value{font-size:2.5rem;font-weight:700;color:var(--p);margin-bottom:.5rem}
.kpi-label{color:var(--gray);font-size:.875rem}
.kpi-chart{margin-top:2rem;padding:1rem;background:var(--gray-l);border-radius:var(--r)}

@media(max-width:768px){
.kanban-board{grid-template-columns:1fr}
.header-content{flex-direction:column;align-items:stretch}
.space-switcher{justify-content:center}
.filters-bar{flex-direction:column;align-items:stretch}
.voice-btn{right:2rem;bottom:6rem}
}

.loading{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid var(--p);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.drag-over{background-color:rgba(25,118,210,.1)!important;border:2px dashed #1976d2!important}
</style>
</head>
<body>
<header class="app-header">
<div class="header-content">
<div class="header-title">
<h1>TaskFlow</h1>
<div class="space-switcher">
<button class="space-btn" data-space="personal">Personnel</button>
<button class="space-btn active" data-space="professional">Professionnel</button>
</div>
</div>
<div class="header-actions">
<div class="sync-indicator" id="sync-indicator">
<span id="sync-icon">üîÑ</span>
<span id="sync-text">Synchronis√©</span>
</div>
<button class="icon-btn" data-action="refresh" title="Rafra√Æchir">üîÑ</button>
<button class="icon-btn" data-action="archive" title="Archives">üìö</button>
<button class="icon-btn" data-action="kpi" title="KPIs">üìà</button>
<button class="icon-btn" data-action="export" title="Exporter">üì•</button>
<button class="icon-btn" data-action="theme" title="Changer le th√®me">üåô</button>
</div>
</div>
</header>

<main class="main-container">
<div class="filters-bar">
<div class="filter-group">
<label>Cat√©gorie:</label>
<select id="category-filter">
<option value="">Toutes</option>
<option value="method">M√©thode</option>
<option value="quality">Qualit√©</option>
<option value="maintenance">Maintenance</option>
<option value="other">Autre</option>
</select>
</div>
<div class="filter-group">
<label>Priorit√©:</label>
<select id="priority-filter">
<option value="">Toutes</option>
<option value="high">√âlev√©e</option>
<option value="medium">Normale</option>
<option value="low">Basse</option>
</select>
</div>
<div class="filter-group">
<label>Recherche:</label>
<input type="text" id="search-filter" placeholder="Rechercher...">
</div>
</div>

<div class="stats-cards"></div>
<div class="kanban-board"></div>
</main>

<button class="fab add-task-btn" title="Ajouter">+</button>
<button class="fab voice-btn" title="Voix">üé§</button>

<div class="modal" id="task-modal"></div>
<div class="modal" id="delegate-modal"></div>
<div class="modal" id="kpi-modal"></div>
<div class="modal" id="archive-modal"></div>
<div class="notification" id="notification"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
'use strict';

// Configuration Firebase
firebase.initializeApp({
  apiKey: "AIzaSyA0Nq9x4iFK7igvDwdAvy_EeQAISNOu-L0",
  authDomain: "taskflow-d60a7.firebaseapp.com",
  projectId: "taskflow-d60a7",
  storageBucket: "taskflow-d60a7.firebasestorage.app",
  messagingSenderId: "702172024297",
  appId: "1:702172024297:web:f275430edb60ae0d7a0f78"
});

const db = firebase.firestore();

// Enable offline persistence
db.enablePersistence().catch(console.error);

class TaskFlowSync {
    constructor() {
        this.currentSpace = localStorage.getItem('currentSpace') || 'professional';
        this.darkMode = localStorage.getItem('darkMode') === 'true';
        this.tasks = new Map(); // Utiliser Map pour √©viter les doublons
        this.unsubscribe = null;
        this.editingTaskId = null;
        this.delegatingTaskId = null;
        this.draggedTaskId = null;
        
        this.categories = {
            method: 'M√©thode',
            quality: 'Qualit√©', 
            maintenance: 'Maintenance',
            other: 'Autre'
        };
        
        this.statusConfig = {
            'todo': { icon: 'üìã', label: '√Ä faire' },
            'in-progress': { icon: 'üöÄ', label: 'En cours' },
            'delegated': { icon: 'üë•', label: 'D√©l√©gu√©' },
            'done': { icon: '‚úÖ', label: 'R√©alis√©' }
        };
        
        this.init();
    }
    
    async init() {
        this.setupEventListeners();
        this.applyTheme();
        this.updateSpaceButtons();
        await this.loadTasks();
        this.setupSpeechRecognition();
        this.startPeriodicChecks();
        this.monitorConnection();
        this.checkAndArchiveOldTasks();
    }
    
    async loadTasks() {
        // D√©sinscrire l'ancien listener
        if (this.unsubscribe) {
            this.unsubscribe();
            this.unsubscribe = null;
        }
        
        this.updateSyncIndicator('syncing', 'Chargement...');
        
        try {
            // Charger uniquement les t√¢ches de l'espace actuel
            this.unsubscribe = db.collection('tasks')
                .where('space', '==', this.currentSpace)
                .onSnapshot((snapshot) => {
                    // Utiliser Map pour √©viter les doublons
                    this.tasks.clear();
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        // Double v√©rification de l'espace
                        if (data && data.space === this.currentSpace) {
                            this.tasks.set(doc.id, {
                                ...data,
                                id: doc.id
                            });
                        }
                    });
                    
                    this.render();
                    this.updateSyncIndicator('synced', 'Synchronis√©');
                }, (error) => {
                    console.error('Erreur:', error);
                    this.updateSyncIndicator('error', 'Erreur');
                });
        } catch (error) {
            console.error('Erreur chargement:', error);
            this.updateSyncIndicator('error', 'Erreur');
        }
    }
    
    getTasksArray() {
        // Convertir Map en Array pour le rendu
        return Array.from(this.tasks.values());
    }
    
    setupEventListeners() {
        document.addEventListener('click', (e) => {
            const target = e.target;
            
            if (target.matches('.icon-btn')) {
                const action = target.dataset.action;
                if (action === 'refresh') this.refresh();
                else if (action === 'archive') this.showArchiveModal();
                else if (action === 'kpi') this.showKPIModal();
                else if (action === 'export') this.exportTasks();
                else if (action === 'theme') this.toggleTheme();
            }
            
            if (target.matches('.space-btn')) {
                this.switchSpace(target.dataset.space);
            }
            
            if (target.matches('.delete-btn')) {
                e.stopPropagation();
                const taskId = target.closest('.task-card').dataset.taskId;
                this.deleteTask(taskId);
            }
            
            const taskCard = target.closest('.task-card');
            if (taskCard && !target.matches('.delete-btn') && this.draggedTaskId === null) {
                const taskId = taskCard.dataset.taskId;
                this.editTask(taskId);
            }
            
            if (target.matches('[data-close]')) {
                this.closeModal(target.dataset.close);
            }
            
            if (target.matches('[data-period]')) {
                this.showKPIPeriod(target.dataset.period);
            }
        });
        
        document.querySelector('.add-task-btn').addEventListener('click', () => this.createTask());
        document.querySelector('.voice-btn').addEventListener('click', () => this.toggleVoiceRecording());
        
        document.getElementById('category-filter').addEventListener('change', () => this.render());
        document.getElementById('priority-filter').addEventListener('change', () => this.render());
        document.getElementById('search-filter').addEventListener('input', 
            this.debounce(() => this.render(), 300)
        );
    }
    
    async switchSpace(space) {
        if (this.currentSpace === space) return;
        
        this.currentSpace = space;
        localStorage.setItem('currentSpace', space);
        this.updateSpaceButtons();
        
        // Recharger les t√¢ches du nouvel espace
        await this.loadTasks();
    }
    
    updateSpaceButtons() {
        document.querySelectorAll('.space-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.space === this.currentSpace);
        });
    }
    
    render() {
        this.renderStats();
        this.renderKanban();
    }
    
    renderStats() {
        const tasks = this.getFilteredTasks();
        const currentWeek = this.getWeekNumber(new Date());
        const currentYear = new Date().getFullYear();
        
        const stats = {
            total: tasks.length,
            todo: tasks.filter(t => t.status === 'todo').length,
            inProgress: tasks.filter(t => t.status === 'in-progress').length,
            done: tasks.filter(t => {
                if (t.status !== 'done' || !t.completedAt) return false;
                const completedDate = new Date(t.completedAt);
                return this.getWeekNumber(completedDate) === currentWeek && 
                       completedDate.getFullYear() === currentYear;
            }).length
        };
        
        document.querySelector('.stats-cards').innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${stats.total}</div>
                <div class="stat-label">Total des t√¢ches</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.todo}</div>
                <div class="stat-label">√Ä faire</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.inProgress}</div>
                <div class="stat-label">En cours</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.done}</div>
                <div class="stat-label">R√©alis√©es S${currentWeek}</div>
            </div>
        `;
    }
    
    renderKanban() {
        const board = document.querySelector('.kanban-board');
        
        // Toujours recr√©er la structure compl√®te du kanban
        board.innerHTML = Object.keys(this.statusConfig).map(status => `
            <div class="kanban-column" data-status="${status}">
                <div class="column-header">
                    <h3 class="column-title">
                        ${this.statusConfig[status].icon} ${this.statusConfig[status].label}
                        <span class="column-count">0</span>
                    </h3>
                </div>
                <div class="tasks-container" data-status="${status}"></div>
            </div>
        `).join('');
        
        // Ajouter les t√¢ches filtr√©es
        const filteredTasks = this.getFilteredTasks();
        const tasksByStatus = {
            'todo': [],
            'in-progress': [],
            'delegated': [],
            'done': []
        };
        
        // Grouper les t√¢ches par statut
        filteredTasks.forEach(task => {
            if (tasksByStatus[task.status]) {
                tasksByStatus[task.status].push(task);
            }
        });
        
        // Ajouter les t√¢ches dans les conteneurs appropri√©s
        Object.entries(tasksByStatus).forEach(([status, tasks]) => {
            const container = document.querySelector(`.tasks-container[data-status="${status}"]`);
            if (container) {
                tasks.forEach(task => {
                    const element = this.createTaskElement(task);
                    container.appendChild(element);
                });
                
                // Mettre √† jour le compteur
                const column = container.closest('.kanban-column');
                const countEl = column.querySelector('.column-count');
                if (countEl) {
                    countEl.textContent = tasks.length;
                }
            }
        });
        
        this.setupDragAndDrop();
    }
    
    getFilteredTasks() {
        const category = document.getElementById('category-filter').value;
        const priority = document.getElementById('priority-filter').value;
        const search = document.getElementById('search-filter').value.toLowerCase();
        
        return this.getTasksArray().filter(task => {
            if (task.space !== this.currentSpace) return false;
            if (task.archived) return false; // Exclure les t√¢ches archiv√©es
            if (category && task.category !== category) return false;
            if (priority && task.priority !== priority) return false;
            if (search && !task.title.toLowerCase().includes(search)) return false;
            return true;
        });
    }
    
    createTaskElement(task) {
        const div = document.createElement('div');
        div.className = `task-card priority-${task.priority}`;
        div.dataset.taskId = task.id;
        div.draggable = true;
        
        if (task.deadline && task.priority === 'high') {
            const daysUntil = this.getDaysUntilDeadline(task.deadline);
            if (daysUntil <= 1) div.classList.add('urgent');
        }
        
        let html = `
            <div class="task-header">
                <div class="task-title">${this.escapeHtml(task.title)}</div>
                <span class="task-category">${this.categories[task.category]}</span>
            </div>
        `;
        
        if (task.status === 'done' && task.completedAt) {
            const week = this.getWeekNumber(new Date(task.completedAt));
            html += `<span class="week-badge">S${week}</span>`;
        }
        
        html += `<button class="delete-btn">‚úï</button>`;
        
        if (task.description) {
            html += `<p>${this.escapeHtml(task.description)}</p>`;
        }
        
        const meta = [];
        if (task.deadline) {
            const isClose = this.getDaysUntilDeadline(task.deadline) <= 2;
            meta.push(`<span class="task-meta-item ${isClose ? 'deadline-warning' : ''}">üìÖ ${this.formatDate(task.deadline)}</span>`);
        }
        if (task.estimatedTime) {
            meta.push(`<span class="task-meta-item">‚è±Ô∏è ${task.estimatedTime}h</span>`);
        }
        if (task.delegatedTo) {
            meta.push(`<span class="task-meta-item">üë§ <span class="delegated-to">${this.escapeHtml(task.delegatedTo)}</span></span>`);
        }
        
        if (meta.length) {
            html += `<div class="task-meta">${meta.join('')}</div>`;
        }
        
        div.innerHTML = html;
        
        div.addEventListener('dragstart', (e) => {
            this.draggedTaskId = task.id;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        });
        
        div.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            this.draggedTaskId = null;
        });
        
        return div;
    }
    
    setupDragAndDrop() {
        document.querySelectorAll('.kanban-column').forEach(column => {
            const container = column.querySelector('.tasks-container');
            
            column.ondragover = (e) => {
                e.preventDefault();
                container.classList.add('drag-over');
            };
            
            column.ondragleave = (e) => {
                if (!column.contains(e.relatedTarget)) {
                    container.classList.remove('drag-over');
                }
            };
            
            column.ondrop = async (e) => {
                e.preventDefault();
                container.classList.remove('drag-over');
                
                if (this.draggedTaskId) {
                    const newStatus = column.dataset.status;
                    await this.updateTaskStatus(this.draggedTaskId, newStatus);
                }
            };
        });
    }
    
    async updateTaskStatus(taskId, newStatus) {
        const task = this.tasks.get(taskId);
        if (!task || task.status === newStatus) return;
        
        if (newStatus === 'delegated' && !task.delegatedTo) {
            this.delegatingTaskId = taskId;
            this.showDelegateModal();
            return;
        }
        
        try {
            const updateData = { status: newStatus };
            if (newStatus === 'done' && !task.completedAt) {
                updateData.completedAt = new Date().toISOString();
            }
            
            await db.collection('tasks').doc(taskId).update(updateData);
            this.showNotification('Statut mis √† jour', 'success');
        } catch (error) {
            console.error('Erreur:', error);
            this.showNotification('Erreur de mise √† jour', 'error');
        }
    }
    
    createTask() {
        this.editingTaskId = null;
        this.showTaskModal();
    }
    
    editTask(taskId) {
        this.editingTaskId = taskId;
        this.showTaskModal();
    }
    
    async deleteTask(taskId) {
        if (confirm('Supprimer cette t√¢che ?')) {
            try {
                await db.collection('tasks').doc(taskId).delete();
                this.showNotification('T√¢che supprim√©e', 'success');
            } catch (error) {
                console.error('Erreur:', error);
                this.showNotification('Erreur de suppression', 'error');
            }
        }
    }
    
    showTaskModal() {
        const modal = document.getElementById('task-modal');
        const isEdit = this.editingTaskId !== null;
        const task = isEdit ? this.tasks.get(this.editingTaskId) : null;
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'Modifier' : 'Nouvelle'} t√¢che</h2>
                    <button class="close-btn" data-close="task-modal">√ó</button>
                </div>
                <form id="task-form" onsubmit="app.saveTask(event)">
                    <div class="form-group">
                        <label class="form-label">Titre *</label>
                        <input type="text" class="form-input" name="title" value="${task ? this.escapeHtml(task.title) : ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description">${task ? this.escapeHtml(task.description || '') : ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cat√©gorie</label>
                        <select class="form-select" name="category">
                            ${Object.entries(this.categories).map(([k, v]) => 
                                `<option value="${k}" ${task && task.category === k ? 'selected' : ''}>${v}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priorit√©</label>
                        <select class="form-select" name="priority">
                            <option value="low" ${task && task.priority === 'low' ? 'selected' : ''}>Basse</option>
                            <option value="medium" ${task && task.priority === 'medium' ? 'selected' : ''}>Normale</option>
                            <option value="high" ${task && task.priority === 'high' ? 'selected' : ''}>√âlev√©e</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">√âch√©ance</label>
                        <input type="date" class="form-input" name="deadline" value="${task ? task.deadline || '' : ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Temps estim√© (heures)</label>
                        <input type="number" class="form-input" name="estimatedTime" min="0.5" step="0.5" value="${task ? task.estimatedTime || '' : ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Statut</label>
                        <select class="form-select" name="status" onchange="app.toggleDelegatedField(this.value)">
                            ${Object.entries(this.statusConfig).map(([k, v]) => 
                                `<option value="${k}" ${task && task.status === k ? 'selected' : ''}>${v.label}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group" id="delegated-group" style="display: ${task && task.status === 'delegated' ? 'block' : 'none'}">
                        <label class="form-label">D√©l√©gu√© √†</label>
                        <input type="text" class="form-input" name="delegatedTo" value="${task ? task.delegatedTo || '' : ''}">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" data-close="task-modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">${isEdit ? 'Mettre √† jour' : 'Cr√©er'}</button>
                    </div>
                </form>
            </div>
        `;
        
        this.openModal('task-modal');
    }
    
    async saveTask(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData);
        
        const taskData = {
            title: data.title,
            description: data.description,
            category: data.category,
            priority: data.priority,
            status: data.status,
            deadline: data.deadline,
            estimatedTime: parseFloat(data.estimatedTime) || 0,
            delegatedTo: data.delegatedTo,
            space: this.currentSpace
        };
        
        if (taskData.status === 'done' && !this.editingTaskId) {
            taskData.completedAt = new Date().toISOString();
        }
        
        try {
            if (this.editingTaskId) {
                await db.collection('tasks').doc(this.editingTaskId).update(taskData);
                this.showNotification('T√¢che mise √† jour', 'success');
            } else {
                taskData.createdAt = new Date().toISOString();
                await db.collection('tasks').add(taskData);
                this.showNotification('T√¢che cr√©√©e', 'success');
            }
            
            this.closeModal('task-modal');
        } catch (error) {
            console.error('Erreur:', error);
            this.showNotification('Erreur de sauvegarde', 'error');
        }
    }
    
    showDelegateModal() {
        const modal = document.getElementById('delegate-modal');
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">D√©l√©guer la t√¢che</h2>
                    <button class="close-btn" data-close="delegate-modal">√ó</button>
                </div>
                <form id="delegate-form" onsubmit="app.saveDelegate(event)">
                    <div class="form-group">
                        <label class="form-label">D√©l√©guer √† *</label>
                        <input type="text" class="form-input" name="delegatedTo" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date de relance</label>
                        <input type="date" class="form-input" name="reminder">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" data-close="delegate-modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">D√©l√©guer</button>
                    </div>
                </form>
            </div>
        `;
        
        this.openModal('delegate-modal');
    }
    
    async saveDelegate(event) {
        event.preventDefault();
        if (!this.delegatingTaskId) return;
        
        const formData = new FormData(event.target);
        
        try {
            await db.collection('tasks').doc(this.delegatingTaskId).update({
                delegatedTo: formData.get('delegatedTo'),
                delegateReminder: formData.get('reminder'),
                status: 'delegated'
            });
            
            this.closeModal('delegate-modal');
            this.showNotification('T√¢che d√©l√©gu√©e', 'success');
        } catch (error) {
            console.error('Erreur:', error);
            this.showNotification('Erreur de d√©l√©gation', 'error');
        }
        
        this.delegatingTaskId = null;
    }
    
    toggleDelegatedField(status) {
        document.getElementById('delegated-group').style.display = 
            status === 'delegated' ? 'block' : 'none';
    }
    
    async refresh() {
        const btn = document.querySelector('[data-action="refresh"]');
        btn.style.animation = 'spin 1s linear';
        
        // Forcer le rechargement complet
        await this.loadTasks();
        
        setTimeout(() => {
            btn.style.animation = '';
        }, 1000);
    }
    
    // Reconnaissance vocale
    setupSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window)) return;
        
        this.recognition = new webkitSpeechRecognition();
        this.recognition.lang = 'fr-FR';
        this.recognition.continuous = false;
        
        this.recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            this.processVoiceCommand(text);
        };
        
        this.recognition.onerror = () => {
            this.showNotification('Erreur de reconnaissance vocale', 'error');
            document.querySelector('.voice-btn').classList.remove('recording');
        };
        
        this.recognition.onend = () => {
            document.querySelector('.voice-btn').classList.remove('recording');
        };
    }
    
    toggleVoiceRecording() {
        const btn = document.querySelector('.voice-btn');
        
        if (btn.classList.contains('recording')) {
            this.recognition.stop();
        } else {
            btn.classList.add('recording');
            this.recognition.start();
            this.showNotification('Parlez maintenant...', 'success');
        }
    }
    
    async processVoiceCommand(text) {
        const task = {
            title: text,
            description: '',
            category: this.parseCategory(text.toLowerCase()),
            priority: this.parsePriority(text.toLowerCase()),
            status: 'todo',
            deadline: this.parseDeadline(text.toLowerCase()),
            estimatedTime: 1,
            space: this.currentSpace,
            createdAt: new Date().toISOString()
        };
        
        try {
            await db.collection('tasks').add(task);
            this.showNotification(`T√¢che ajout√©e: ${text}`, 'success');
        } catch (error) {
            console.error('Erreur:', error);
            this.showNotification('Erreur d\'ajout', 'error');
        }
    }
    
    parseCategory(text) {
        if (/m√©thod|process|proc√©d/i.test(text)) return 'method';
        if (/qualit√©|contr√¥le|audit/i.test(text)) return 'quality';
        if (/mainten|r√©para|entretien/i.test(text)) return 'maintenance';
        return 'other';
    }
    
    parsePriority(text) {
        if (/urgent|important/i.test(text)) return 'high';
        if (/basse|faible/i.test(text)) return 'low';
        return 'medium';
    }
    
    parseDeadline(text) {
        const date = new Date();
        if (/demain/i.test(text)) {
            date.setDate(date.getDate() + 1);
            return date.toISOString().split('T')[0];
        }
        if (/apr√®s.demain/i.test(text)) {
            date.setDate(date.getDate() + 2);
            return date.toISOString().split('T')[0];
        }
        return null;
    }
    
    // KPI Modal
    showKPIModal() {
        const modal = document.getElementById('kpi-modal');
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Indicateurs de Performance</h2>
                    <button class="close-btn" data-close="kpi-modal">√ó</button>
                </div>
                <div id="kpi-content">
                    <div class="kpi-period-selector">
                        <button class="btn btn-primary" data-period="week">Semaine</button>
                        <button class="btn btn-secondary" data-period="month">Mois</button>
                        <button class="btn btn-secondary" data-period="year">Ann√©e</button>
                    </div>
                    <div id="kpi-stats"></div>
                </div>
            </div>
        `;
        
        this.openModal('kpi-modal');
        this.showKPIPeriod('week');
    }
    
    showKPIPeriod(period) {
        document.querySelectorAll('[data-period]').forEach(btn => {
            btn.className = btn.dataset.period === period ? 'btn btn-primary' : 'btn btn-secondary';
        });
        
        const stats = this.calculateKPIStats(period);
        
        document.getElementById('kpi-stats').innerHTML = `
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value">${stats.created}</div>
                    <div class="kpi-label">T√¢ches cr√©√©es</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${stats.completed}</div>
                    <div class="kpi-label">T√¢ches termin√©es</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${stats.inProgress}</div>
                    <div class="kpi-label">En cours</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${stats.delegated}</div>
                    <div class="kpi-label">D√©l√©gu√©es</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${stats.completionRate}%</div>
                    <div class="kpi-label">Taux de compl√©tion</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${stats.avgTime}h</div>
                    <div class="kpi-label">Temps moyen/t√¢che</div>
                </div>
            </div>
        `;
    }
    
    calculateKPIStats(period) {
        const now = new Date();
        let startDate = new Date();
        
        switch(period) {
            case 'week':
                startDate.setDate(now.getDate() - now.getDay());
                break;
            case 'month':
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                break;
            case 'year':
                startDate = new Date(now.getFullYear(), 0, 1);
                break;
        }
        
        const tasks = this.getTasksArray().filter(t => 
            t.space === this.currentSpace && new Date(t.createdAt) >= startDate
        );
        
        const completed = tasks.filter(t => t.status === 'done');
        const totalTime = completed.reduce((sum, t) => sum + (t.estimatedTime || 0), 0);
        
        return {
            created: tasks.length,
            completed: completed.length,
            inProgress: tasks.filter(t => t.status === 'in-progress').length,
            delegated: tasks.filter(t => t.status === 'delegated').length,
            completionRate: tasks.length ? Math.round((completed.length / tasks.length) * 100) : 0,
            avgTime: completed.length ? (totalTime / completed.length).toFixed(1) : 0
        };
    }
    
    exportTasks() {
        const tasks = this.getTasksArray().filter(t => t.space === this.currentSpace);
        const headers = ['Titre', 'Description', 'Cat√©gorie', 'Priorit√©', 'Statut', '√âch√©ance', 'Temps estim√©', 'D√©l√©gu√© √†'];
        const rows = tasks.map(t => [
            t.title,
            t.description || '',
            this.categories[t.category],
            t.priority,
            t.status,
            t.deadline ? this.formatDate(t.deadline) : '',
            t.estimatedTime || '',
            t.delegatedTo || ''
        ]);
        
        const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tasks_${this.currentSpace}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        this.showNotification('Export r√©ussi', 'success');
    }
    
    // Utilitaires
    monitorConnection() {
        window.addEventListener('online', () => {
            this.updateSyncIndicator('synced', 'En ligne');
            this.loadTasks();
        });
        
        window.addEventListener('offline', () => {
            this.updateSyncIndicator('offline', 'Hors ligne');
        });
    }
    
    updateSyncIndicator(status, text) {
        const indicator = document.getElementById('sync-indicator');
        const icon = document.getElementById('sync-icon');
        const textEl = document.getElementById('sync-text');
        
        indicator.className = 'sync-indicator';
        
        switch(status) {
            case 'syncing':
                indicator.classList.add('syncing');
                icon.textContent = 'üîÑ';
                break;
            case 'synced':
                icon.textContent = '‚úÖ';
                break;
            case 'offline':
                indicator.classList.add('offline');
                icon.textContent = 'üîå';
                break;
            case 'error':
                indicator.classList.add('offline');
                icon.textContent = '‚ùå';
                break;
        }
        
        textEl.textContent = text;
    }
    
    startPeriodicChecks() {
        setInterval(() => this.checkDeadlines(), 60000);
        // V√©rifier l'archivage toutes les heures
        setInterval(() => this.checkAndArchiveOldTasks(), 3600000);
    }
    
    async checkAndArchiveOldTasks() {
        const currentWeek = this.getWeekNumber(new Date());
        const currentYear = new Date().getFullYear();
        let tasksToArchive = [];
        
        this.tasks.forEach(task => {
            if (task.status === 'done' && task.completedAt && !task.archived) {
                const completedDate = new Date(task.completedAt);
                const taskWeek = this.getWeekNumber(completedDate);
                const taskYear = completedDate.getFullYear();
                
                // Archiver si la t√¢che a √©t√© compl√©t√©e dans une semaine diff√©rente ou une ann√©e diff√©rente
                if (taskWeek !== currentWeek || taskYear !== currentYear) {
                    tasksToArchive.push(task.id);
                }
            }
        });
        
        if (tasksToArchive.length > 0) {
            const batch = db.batch();
            
            tasksToArchive.forEach(taskId => {
                const ref = db.collection('tasks').doc(taskId);
                batch.update(ref, { 
                    archived: true,
                    archivedAt: new Date().toISOString()
                });
            });
            
            try {
                await batch.commit();
                this.showNotification(`${tasksToArchive.length} t√¢che(s) archiv√©e(s)`, 'success');
            } catch (error) {
                console.error('Erreur archivage:', error);
            }
        }
    }
    
    async showArchiveModal() {
        const modal = document.getElementById('archive-modal');
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Archives des t√¢ches r√©alis√©es</h2>
                    <button class="close-btn" data-close="archive-modal">√ó</button>
                </div>
                <div id="archive-content">
                    <div class="loading"></div>
                </div>
            </div>
        `;
        
        this.openModal('archive-modal');
        
        // Charger les t√¢ches archiv√©es
        try {
            const snapshot = await db.collection('tasks')
                .where('space', '==', this.currentSpace)
                .where('archived', '==', true)
                .orderBy('completedAt', 'desc')
                .get();
            
            const archivedTasks = [];
            snapshot.forEach(doc => {
                archivedTasks.push({ ...doc.data(), id: doc.id });
            });
            
            this.renderArchivedTasks(archivedTasks);
        } catch (error) {
            console.error('Erreur chargement archives:', error);
            document.getElementById('archive-content').innerHTML = '<p>Erreur de chargement des archives</p>';
        }
    }
    
    renderArchivedTasks(tasks) {
        const content = document.getElementById('archive-content');
        
        if (tasks.length === 0) {
            content.innerHTML = '<p style="text-align: center; color: var(--gray);">Aucune t√¢che archiv√©e</p>';
            return;
        }
        
        // Grouper par semaine
        const tasksByWeek = {};
        tasks.forEach(task => {
            const date = new Date(task.completedAt);
            const year = date.getFullYear();
            const week = this.getWeekNumber(date);
            const key = `${year}-S${week}`;
            
            if (!tasksByWeek[key]) {
                tasksByWeek[key] = [];
            }
            tasksByWeek[key].push(task);
        });
        
        let html = '<div style="max-height: 60vh; overflow-y: auto;">';
        
        Object.entries(tasksByWeek).sort((a, b) => b[0].localeCompare(a[0])).forEach(([weekKey, weekTasks]) => {
            const [year, week] = weekKey.split('-S');
            const totalTime = weekTasks.reduce((sum, t) => sum + (t.estimatedTime || 0), 0);
            
            html += `
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: var(--p);">
                        Semaine ${week} - ${year} 
                        <span style="font-size: 0.875rem; color: var(--gray);">
                            (${weekTasks.length} t√¢ches, ${totalTime}h)
                        </span>
                    </h3>
                    <div style="display: grid; gap: 0.75rem;">
            `;
            
            weekTasks.forEach(task => {
                html += `
                    <div class="task-card priority-${task.priority}" style="opacity: 0.9;">
                        <div class="task-header">
                            <div class="task-title">${this.escapeHtml(task.title)}</div>
                            <span class="task-category">${this.categories[task.category]}</span>
                        </div>
                        ${task.description ? `<p style="font-size: 0.875rem;">${this.escapeHtml(task.description)}</p>` : ''}
                        <div class="task-meta">
                            <span class="task-meta-item">‚úÖ ${this.formatDate(task.completedAt)}</span>
                            ${task.estimatedTime ? `<span class="task-meta-item">‚è±Ô∏è ${task.estimatedTime}h</span>` : ''}
                            ${task.delegatedTo ? `<span class="task-meta-item">üë§ ${this.escapeHtml(task.delegatedTo)}</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
        });
        
        html += '</div>';
        
        html += `
            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--gray-l); display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="app.exportArchivedTasks()">
                    üì• Exporter les archives
                </button>
                <button class="btn btn-secondary" data-close="archive-modal">Fermer</button>
            </div>
        `;
        
        content.innerHTML = html;
    }
    
    async exportArchivedTasks() {
        try {
            const snapshot = await db.collection('tasks')
                .where('space', '==', this.currentSpace)
                .where('archived', '==', true)
                .orderBy('completedAt', 'desc')
                .get();
            
            const tasks = [];
            snapshot.forEach(doc => {
                tasks.push(doc.data());
            });
            
            const headers = ['Titre', 'Description', 'Cat√©gorie', 'Priorit√©', 'Date r√©alisation', 'Temps estim√©', 'D√©l√©gu√© √†', 'Semaine'];
            const rows = tasks.map(t => {
                const date = new Date(t.completedAt);
                return [
                    t.title,
                    t.description || '',
                    this.categories[t.category],
                    t.priority,
                    this.formatDate(t.completedAt),
                    t.estimatedTime || '',
                    t.delegatedTo || '',
                    `S${this.getWeekNumber(date)}-${date.getFullYear()}`
                ];
            });
            
            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `archives_${this.currentSpace}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            this.showNotification('Archives export√©es', 'success');
        } catch (error) {
            console.error('Erreur export:', error);
            this.showNotification('Erreur d\'export', 'error');
        }
    }
    
    checkDeadlines() {
        const now = new Date();
        this.getTasksArray().forEach(task => {
            if (task.deadline && task.status !== 'done' && task.space === this.currentSpace) {
                const daysUntil = this.getDaysUntilDeadline(task.deadline);
                
                if (task.priority === 'high' && [5, 3, 1].includes(daysUntil)) {
                    this.showNotification(`Rappel: "${task.title}" dans ${daysUntil} jours`, 'warning');
                } else if (daysUntil === 1) {
                    this.showNotification(`Rappel: "${task.title}" demain`, 'warning');
                }
            }
        });
    }
    
    openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }
    
    closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        if (modalId === 'task-modal') this.editingTaskId = null;
        if (modalId === 'delegate-modal') this.delegatingTaskId = null;
    }
    
    showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        clearTimeout(this.notificationTimeout);
        this.notificationTimeout = setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    toggleTheme() {
        this.darkMode = !this.darkMode;
        document.body.classList.toggle('dark');
        localStorage.setItem('darkMode', this.darkMode);
        document.querySelector('[data-action="theme"]').textContent = this.darkMode ? '‚òÄÔ∏è' : 'üåô';
    }
    
    applyTheme() {
        if (this.darkMode) {
            document.body.classList.add('dark');
            document.querySelector('[data-action="theme"]').textContent = '‚òÄÔ∏è';
        }
    }
    
    formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('fr-FR');
    }
    
    getDaysUntilDeadline(deadline) {
        return Math.ceil((new Date(deadline) - new Date()) / (1000 * 60 * 60 * 24));
    }
    
    getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    debounce(func, wait) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
}

// Initialisation
const app = new TaskFlowSync();
window.app = app;

// Cleanup
window.addEventListener('beforeunload', () => {
    if (app.unsubscribe) app.unsubscribe();
});
</script>
</body>
</html>