<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#1976d2">
<title>TaskFlow - Synchronis√©</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--p:#1976d2;--s:#dc004e;--ok:#4caf50;--warn:#ff9800;--err:#f44336;--dark:#1a1a1a;--light:#fff;--gray-l:#f5f5f5;--gray:#9e9e9e;--sh:0 2px 4px rgba(0,0,0,.1);--r:8px}
body{font-family:system-ui,-apple-system,sans-serif;background:var(--gray-l);color:var(--dark);transition:.3s}
body.dark{background:#121212;color:var(--light)}
body.dark .card,body.dark .filters-bar,body.dark .stat-card,body.dark .task-card,body.dark .modal-content,body.dark .kpi-card{background:#1e1e1e;color:var(--light)}
body.dark .kanban-column{background:rgba(30,30,30,.7)}

.app-header{background:var(--p);color:#fff;padding:1rem;box-shadow:var(--sh);position:sticky;top:0;z-index:1000}
.header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
.header-title{display:flex;align-items:center;gap:1rem}
.space-switcher{display:flex;gap:.5rem;background:rgba(255,255,255,.2);padding:.25rem;border-radius:var(--r)}
.space-btn{padding:.5rem 1rem;border:0;background:0;color:#fff;cursor:pointer;border-radius:6px;transition:.3s}
.space-btn.active{background:#fff;color:var(--p)}
.header-actions{display:flex;gap:1rem;align-items:center}
.icon-btn{background:0;border:0;color:#fff;cursor:pointer;padding:.5rem;border-radius:50%;transition:.3s}
.icon-btn:hover{background:rgba(255,255,255,.2)}

.sync-indicator{display:inline-flex;align-items:center;gap:0.5rem;padding:0.25rem 0.75rem;background:rgba(255,255,255,0.2);border-radius:20px;font-size:0.875rem}
.sync-indicator.syncing{animation:pulse 2s infinite}
.sync-indicator.offline{background:rgba(255,100,100,0.3)}

.main-container{max-width:1400px;margin:2rem auto;padding:0 1rem}
.filters-bar{background:#fff;padding:1rem;border-radius:var(--r);box-shadow:var(--sh);margin-bottom:2rem;display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
.filter-group{display:flex;gap:.5rem;align-items:center}
select,input{padding:.5rem 1rem;border:1px solid #ddd;border-radius:6px;font-size:14px;transition:.3s}
select:focus,input:focus{outline:0;border-color:var(--p);box-shadow:0 0 0 3px rgba(25,118,210,.1)}

.stats-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-bottom:2rem}
.stat-card{background:#fff;padding:1.5rem;border-radius:var(--r);box-shadow:var(--sh);text-align:center;transition:transform .3s}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
.stat-value{font-size:2rem;font-weight:700;color:var(--p)}
.stat-label{color:var(--gray);margin-top:.5rem}

.kanban-board{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;margin-bottom:2rem}
.kanban-column{background:rgba(255,255,255,.7);border-radius:var(--r);padding:1rem;min-height:400px;position:relative;z-index:1}
.column-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:2px solid var(--gray-l)}
.column-title{font-weight:600;display:flex;align-items:center;gap:.5rem}
.column-count{background:var(--gray-l);color:var(--gray);padding:.25rem .5rem;border-radius:12px;font-size:.875rem}
.tasks-container{min-height:50px;padding:.5rem;transition:.3s}

.task-card{background:#fff;padding:1rem;border-radius:var(--r);box-shadow:var(--sh);margin-bottom:.75rem;cursor:grab;transition:.3s;position:relative;overflow:hidden;user-select:none}
.task-card:active{cursor:grabbing}
.task-card.dragging{opacity:0.5;pointer-events:none}
.task-card .delete-btn{position:absolute;top:.5rem;right:.5rem;background:var(--err);color:#fff;border:0;border-radius:50%;width:24px;height:24px;font-size:12px;cursor:pointer;opacity:0;transition:opacity .3s}
.task-card:hover .delete-btn{opacity:1}
.task-card.priority-high{border-left:4px solid var(--err)}
.task-card.priority-medium{border-left:4px solid var(--warn)}
.task-card.priority-low{border-left:4px solid var(--ok)}
.task-card.urgent{animation:pulse-border 2s infinite}
@keyframes pulse-border{0%{box-shadow:0 0 0 0 rgba(244,67,54,.7)}70%{box-shadow:0 0 0 6px rgba(244,67,54,0)}100%{box-shadow:0 0 0 0 rgba(244,67,54,0)}}
.week-badge{position:absolute;top:.5rem;right:2.5rem;background:var(--p);color:#fff;padding:.25rem .5rem;border-radius:12px;font-size:.75rem;font-weight:600}
.task-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:.5rem}
.task-title{font-weight:500;flex:1}
.task-category{font-size:.75rem;padding:.25rem .5rem;background:var(--gray-l);border-radius:12px;color:var(--gray)}
.task-meta{display:flex;gap:1rem;margin-top:.5rem;font-size:.875rem;color:var(--gray)}
.task-meta-item{display:flex;align-items:center;gap:.25rem}
.delegated-to{color:var(--p);font-weight:500}
.deadline-warning{color:var(--err);font-weight:500}

.fab{position:fixed;bottom:2rem;width:56px;height:56px;color:#fff;border:0;border-radius:50%;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:.3s;z-index:90;font-size:24px}
.fab:hover{transform:scale(1.1);box-shadow:0 6px 16px rgba(0,0,0,.2)}
.add-task-btn{background:var(--p);right:2rem}
.voice-btn{background:var(--s);right:6rem;font-size:20px}
.voice-btn.recording{animation:pulse 1.5s infinite;background:var(--err)}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center;padding:1rem}
.modal.active{display:flex}
.modal-content{background:#fff;padding:2rem;border-radius:var(--r);width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.modal-title{font-size:1.5rem;font-weight:600}
.close-btn{background:0;border:0;font-size:1.5rem;cursor:pointer;color:var(--gray);padding:.5rem}

.form-group{margin-bottom:1.5rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:500}
.form-input,.form-select,.form-textarea{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:6px;font-size:1rem;transition:.3s}
.form-textarea{min-height:100px;resize:vertical}
.form-actions{display:flex;gap:1rem;justify-content:flex-end;margin-top:2rem}
.btn{padding:.75rem 1.5rem;border:0;border-radius:6px;font-size:1rem;cursor:pointer;transition:.3s}
.btn-primary{background:var(--p);color:#fff}
.btn-primary:hover{background:#1565c0}
.btn-secondary{background:var(--gray-l);color:var(--dark)}
.btn-secondary:hover{background:#e0e0e0}

.notification{position:fixed;top:5rem;right:1rem;background:#fff;padding:1rem 1.5rem;border-radius:var(--r);box-shadow:0 4px 12px rgba(0,0,0,.15);transform:translateX(400px);transition:transform .3s;z-index:3000;max-width:300px}
.notification.show{transform:translateX(0)}
.notification.success{border-left:4px solid var(--ok)}
.notification.error{border-left:4px solid var(--err)}
.notification.warning{border-left:4px solid var(--warn)}

.kpi-period-selector{display:flex;gap:1rem;justify-content:center;margin-bottom:2rem}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-top:2rem}
.kpi-card{background:var(--gray-l);padding:1.5rem;border-radius:var(--r);text-align:center}
.kpi-value{font-size:2.5rem;font-weight:700;color:var(--p);margin-bottom:.5rem}
.kpi-label{color:var(--gray);font-size:.875rem}
.kpi-chart{margin-top:2rem;padding:1rem;background:var(--gray-l);border-radius:var(--r)}

@media(max-width:768px){
.kanban-board{grid-template-columns:1fr}
.header-content{flex-direction:column;align-items:stretch}
.space-switcher{justify-content:center}
.filters-bar{flex-direction:column;align-items:stretch}
.voice-btn{right:2rem;bottom:6rem}
}

.loading{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid var(--p);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.drag-over{background-color:rgba(25,118,210,.1)!important;border:2px dashed #1976d2!important}
</style>
</head>
<body>
<header class="app-header">
<div class="header-content">
<div class="header-title">
<h1>TaskFlow</h1>
<div class="space-switcher">
<button class="space-btn" data-space="personal">Personnel</button>
<button class="space-btn active" data-space="professional">Professionnel</button>
</div>
</div>
<div class="header-actions">
<div class="sync-indicator" id="sync-indicator">
<span id="sync-icon">üîÑ</span>
<span id="sync-text">Synchronis√©</span>
</div>
<button class="icon-btn" data-action="kpi" title="KPIs">üìà</button>
<button class="icon-btn" data-action="stats" title="Statistiques">üìä</button>
<button class="icon-btn" data-action="export" title="Exporter">üì•</button>
<button class="icon-btn" data-action="theme" title="Changer le th√®me">üåô</button>
<button class="icon-btn" data-action="settings" title="Param√®tres">‚öôÔ∏è</button>
</div>
</div>
</header>

<main class="main-container">
<div class="filters-bar">
<div class="filter-group">
<label>Cat√©gorie:</label>
<select id="category-filter">
<option value="">Toutes</option>
<option value="method">M√©thode</option>
<option value="quality">Qualit√©</option>
<option value="maintenance">Maintenance</option>
<option value="other">Autre</option>
</select>
</div>
<div class="filter-group">
<label>Priorit√©:</label>
<select id="priority-filter">
<option value="">Toutes</option>
<option value="high">√âlev√©e</option>
<option value="medium">Normale</option>
<option value="low">Basse</option>
</select>
</div>
<div class="filter-group">
<label>Recherche:</label>
<input type="text" id="search-filter" placeholder="Rechercher...">
</div>
</div>

<div class="stats-cards"></div>
<div class="kanban-board"></div>
</main>

<button class="fab add-task-btn" title="Ajouter">+</button>
<button class="fab voice-btn" title="Voix">üé§</button>

<div class="modal" id="task-modal"></div>
<div class="modal" id="delegate-modal"></div>
<div class="modal" id="kpi-modal"></div>
<div class="notification" id="notification"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
'use strict';

// Configuration Firebase
const firebaseConfig = {
  apiKey: "AIzaSyA0Nq9x4iFK7igvDwdAvy_EeQAISNOu-L0",
  authDomain: "taskflow-d60a7.firebaseapp.com",
  projectId: "taskflow-d60a7",
  storageBucket: "taskflow-d60a7.firebasestorage.app",
  messagingSenderId: "702172024297",
  appId: "1:702172024297:web:f275430edb60ae0d7a0f78",
  measurementId: "G-3KRLKNW8R4"
};

// Initialiser Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Enable offline persistence
db.enablePersistence()
  .catch((err) => {
      if (err.code === 'failed-precondition') {
          console.log('Persistence failed: Multiple tabs open');
      } else if (err.code === 'unimplemented') {
          console.log('Persistence not available');
      }
  });

// Gestionnaire de t√¢ches avec Firebase
class TaskFlowFirebase {
    constructor() {
        // √âtat global
        this.currentSpace = localStorage.getItem('currentSpace') || 'professional';
        this.darkMode = localStorage.getItem('darkMode') === 'true';
        this.tasks = [];
        this.unsubscribe = null;
        
        // √âtat temporaire
        this.editingTaskId = null;
        this.delegatingTaskId = null;
        this.draggedTaskId = null;
        
        // Configuration
        this.categories = {
            method: 'M√©thode',
            quality: 'Qualit√©', 
            maintenance: 'Maintenance',
            other: 'Autre'
        };
        
        this.statusConfig = {
            'todo': { icon: 'üìã', label: '√Ä faire' },
            'in-progress': { icon: 'üöÄ', label: 'En cours' },
            'delegated': { icon: 'üë•', label: 'D√©l√©gu√©' },
            'done': { icon: '‚úÖ', label: 'R√©alis√©' }
        };
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.applyTheme();
        this.setupFirestoreListener();
        this.setupSpeechRecognition();
        this.startPeriodicChecks();
        this.monitorConnection();
    }
    
    // Firebase Listener
    setupFirestoreListener() {
        // Afficher l'indicateur de chargement
        this.updateSyncIndicator('syncing', 'Synchronisation...');
        
        // √âcouter les changements en temps r√©el
        this.unsubscribe = db.collection('tasks')
            .onSnapshot((snapshot) => {
                this.tasks = [];
                snapshot.forEach((doc) => {
                    this.tasks.push({ ...doc.data(), id: doc.id });
                });
                this.render();
                this.updateSyncIndicator('synced', 'Synchronis√©');
            }, (error) => {
                console.error('Erreur Firestore:', error);
                this.updateSyncIndicator('error', 'Erreur de sync');
                this.showNotification('Erreur de synchronisation', 'error');
            });
    }
    
    // Monitorer la connexion
    monitorConnection() {
        window.addEventListener('online', () => {
            this.updateSyncIndicator('synced', 'En ligne');
            this.showNotification('Connexion r√©tablie', 'success');
        });
        
        window.addEventListener('offline', () => {
            this.updateSyncIndicator('offline', 'Hors ligne');
            this.showNotification('Mode hors ligne - Les modifications seront synchronis√©es', 'warning');
        });
    }
    
    updateSyncIndicator(status, text) {
        const indicator = document.getElementById('sync-indicator');
        const icon = document.getElementById('sync-icon');
        const textEl = document.getElementById('sync-text');
        
        indicator.className = 'sync-indicator';
        
        switch(status) {
            case 'syncing':
                indicator.classList.add('syncing');
                icon.textContent = 'üîÑ';
                break;
            case 'synced':
                icon.textContent = '‚úÖ';
                break;
            case 'offline':
                indicator.classList.add('offline');
                icon.textContent = 'üîå';
                break;
            case 'error':
                indicator.classList.add('offline');
                icon.textContent = '‚ùå';
                break;
        }
        
        textEl.textContent = text;
    }
    
    // Sauvegarder une t√¢che dans Firebase
    async saveTaskToFirebase(task) {
        try {
            this.updateSyncIndicator('syncing', 'Sauvegarde...');
            
            if (task.id && typeof task.id === 'string') {
                // Mise √† jour
                await db.collection('tasks').doc(task.id).update(task);
            } else {
                // Cr√©ation - Retirer l'ID temporaire
                const { id, ...taskData } = task;
                await db.collection('tasks').add(taskData);
            }
            
            this.updateSyncIndicator('synced', 'Synchronis√©');
        } catch (error) {
            console.error('Erreur sauvegarde:', error);
            this.showNotification('Erreur de sauvegarde', 'error');
            this.updateSyncIndicator('error', 'Erreur');
        }
    }
    
    // Supprimer une t√¢che de Firebase
    async deleteTaskFromFirebase(taskId) {
        try {
            this.updateSyncIndicator('syncing', 'Suppression...');
            await db.collection('tasks').doc(taskId).delete();
            this.updateSyncIndicator('synced', 'Synchronis√©');
        } catch (error) {
            console.error('Erreur suppression:', error);
            this.showNotification('Erreur de suppression', 'error');
        }
    }
    
    setupEventListeners() {
        // D√©l√©gation d'√©v√©nements pour les clics
        document.addEventListener('click', (e) => {
            const target = e.target;
            
            // Actions header
            if (target.matches('.icon-btn')) {
                const action = target.dataset.action;
                if (action === 'kpi') this.showKPIModal();
                else if (action === 'export') this.exportTasks();
                else if (action === 'theme') this.toggleTheme();
            }
            
            // Changement d'espace
            if (target.matches('.space-btn')) {
                this.switchSpace(target.dataset.space);
            }
            
            // Suppression de t√¢che
            if (target.matches('.delete-btn')) {
                e.stopPropagation();
                const taskId = target.closest('.task-card').dataset.taskId;
                this.deleteTask(taskId);
            }
            
            // √âdition de t√¢che
            const taskCard = target.closest('.task-card');
            if (taskCard && !target.matches('.delete-btn') && this.draggedTaskId === null) {
                const taskId = taskCard.dataset.taskId;
                this.editTask(taskId);
            }
            
            // Fermeture modale
            if (target.matches('[data-close]')) {
                this.closeModal(target.dataset.close);
            }
            
            // P√©riode KPI
            if (target.matches('[data-period]')) {
                this.showKPIPeriod(target.dataset.period);
            }
        });
        
        // Boutons flottants
        document.querySelector('.add-task-btn').addEventListener('click', () => this.createTask());
        document.querySelector('.voice-btn').addEventListener('click', () => this.toggleVoiceRecording());
        
        // Filtres
        document.getElementById('category-filter').addEventListener('change', () => this.render());
        document.getElementById('priority-filter').addEventListener('change', () => this.render());
        document.getElementById('search-filter').addEventListener('input', 
            this.debounce(() => this.render(), 300)
        );
    }
    
    render() {
        this.renderStats();
        this.renderKanban();
    }
    
    renderStats() {
        const stats = this.calculateStats();
        const currentWeek = this.getWeekNumber(new Date());
        
        document.querySelector('.stats-cards').innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${stats.total}</div>
                <div class="stat-label">Total des t√¢ches</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.todo}</div>
                <div class="stat-label">√Ä faire</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.inProgress}</div>
                <div class="stat-label">En cours</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.done}</div>
                <div class="stat-label">R√©alis√©es S${currentWeek}</div>
            </div>
        `;
    }
    
    renderKanban() {
        const board = document.querySelector('.kanban-board');
        
        // Cr√©er les colonnes si n√©cessaire
        if (!board.children.length) {
            board.innerHTML = Object.keys(this.statusConfig).map(status => `
                <div class="kanban-column" data-status="${status}">
                    <div class="column-header">
                        <h3 class="column-title">
                            ${this.statusConfig[status].icon} ${this.statusConfig[status].label}
                            <span class="column-count">0</span>
                        </h3>
                    </div>
                    <div class="tasks-container" data-status="${status}"></div>
                </div>
            `).join('');
        }
        
        // Vider les conteneurs
        document.querySelectorAll('.tasks-container').forEach(c => c.innerHTML = '');
        
        // Filtrer et afficher les t√¢ches
        const filteredTasks = this.getFilteredTasks();
        filteredTasks.forEach(task => {
            const element = this.createTaskElement(task);
            const container = document.querySelector(`[data-status="${task.status}"]`);
            if (container) container.appendChild(element);
        });
        
        // Mettre √† jour les compteurs
        document.querySelectorAll('.kanban-column').forEach(col => {
            const count = col.querySelectorAll('.task-card').length;
            col.querySelector('.column-count').textContent = count;
        });
        
        // Configurer le drag & drop
        this.setupDragAndDrop();
    }
    
    createTaskElement(task) {
        const div = document.createElement('div');
        div.className = `task-card priority-${task.priority}`;
        div.dataset.taskId = task.id;
        div.draggable = true;
        
        // V√©rifier l'urgence
        if (task.deadline && task.priority === 'high') {
            const daysUntil = this.getDaysUntilDeadline(task.deadline);
            if (daysUntil <= 1) div.classList.add('urgent');
        }
        
        // Construire le HTML
        let html = `
            <div class="task-header">
                <div class="task-title">${this.escapeHtml(task.title)}</div>
                <span class="task-category">${this.categories[task.category]}</span>
            </div>
        `;
        
        // Badge de semaine pour les t√¢ches termin√©es
        if (task.status === 'done' && task.completedAt) {
            const week = this.getWeekNumber(new Date(task.completedAt));
            html += `<span class="week-badge">S${week}</span>`;
        }
        
        // Bouton de suppression
        html += `<button class="delete-btn">‚úï</button>`;
        
        // Description
        if (task.description) {
            html += `<p>${this.escapeHtml(task.description)}</p>`;
        }
        
        // M√©tadonn√©es
        const meta = [];
        if (task.deadline) {
            const isClose = this.getDaysUntilDeadline(task.deadline) <= 2;
            meta.push(`<span class="task-meta-item ${isClose ? 'deadline-warning' : ''}">üìÖ ${this.formatDate(task.deadline)}</span>`);
        }
        if (task.estimatedTime) {
            meta.push(`<span class="task-meta-item">‚è±Ô∏è ${task.estimatedTime}h</span>`);
        }
        if (task.delegatedTo) {
            meta.push(`<span class="task-meta-item">üë§ <span class="delegated-to">${this.escapeHtml(task.delegatedTo)}</span></span>`);
        }
        
        if (meta.length) {
            html += `<div class="task-meta">${meta.join('')}</div>`;
        }
        
        div.innerHTML = html;
        
        // √âv√©nements de drag
        div.addEventListener('dragstart', (e) => {
            e.stopPropagation();
            this.draggedTaskId = task.id;
            setTimeout(() => {
                e.target.classList.add('dragging');
            }, 0);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', task.id);
        });
        
        div.addEventListener('dragend', (e) => {
            e.stopPropagation();
            e.target.classList.remove('dragging');
            this.draggedTaskId = null;
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        });
        
        return div;
    }
    
    setupDragAndDrop() {
        document.querySelectorAll('.kanban-column').forEach(column => {
            const container = column.querySelector('.tasks-container');
            
            column.ondragover = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                container.classList.add('drag-over');
            };
            
            column.ondragleave = (e) => {
                if (!column.contains(e.relatedTarget)) {
                    container.classList.remove('drag-over');
                }
            };
            
            column.ondrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                container.classList.remove('drag-over');
                
                if (this.draggedTaskId !== null) {
                    const newStatus = column.dataset.status;
                    this.updateTaskStatus(this.draggedTaskId, newStatus);
                    this.draggedTaskId = null;
                }
            };
        });
    }
    
    async updateTaskStatus(taskId, newStatus) {
        if (!taskId) return;
        
        const task = this.tasks.find(t => t.id === taskId);
        if (!task || task.status === newStatus) return;
        
        // Si d√©l√©gation sans personne assign√©e
        if (newStatus === 'delegated' && !task.delegatedTo) {
            this.delegatingTaskId = taskId;
            this.draggedTaskId = null;
            this.showDelegateModal();
            return;
        }
        
        // Mettre √† jour le statut
        task.status = newStatus;
        if (newStatus === 'done' && !task.completedAt) {
            task.completedAt = new Date().toISOString();
        }
        
        await this.saveTaskToFirebase(task);
        this.showNotification('Statut mis √† jour', 'success');
    }
    
    createTask() {
        this.editingTaskId = null;
        this.showTaskModal();
    }
    
    editTask(taskId) {
        this.editingTaskId = taskId;
        this.showTaskModal();
    }
    
    async deleteTask(taskId) {
        if (confirm('Supprimer cette t√¢che ?')) {
            await this.deleteTaskFromFirebase(taskId);
            this.showNotification('T√¢che supprim√©e', 'success');
        }
    }
    
    showTaskModal() {
        const modal = document.getElementById('task-modal');
        const isEdit = this.editingTaskId !== null;
        const task = isEdit ? this.tasks.find(t => t.id === this.editingTaskId) : null;
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'Modifier' : 'Nouvelle'} t√¢che</h2>
                    <button class="close-btn" data-close="task-modal">√ó</button>
                </div>
                <form id="task-form" onsubmit="app.saveTask(event)">
                    <div class="form-group">
                        <label class="form-label">Titre *</label>
                        <input type="text" class="form-input" name="title" value="${task ? this.escapeHtml(task.title) : ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description">${task ? this.escapeHtml(task.description || '') : ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cat√©gorie</label>
                        <select class="form-select" name="category">
                            ${Object.entries(this.categories).map(([k, v]) => 
                                `<option value="${k}" ${task && task.category === k ? 'selected' : ''}>${v}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priorit√©</label>
                        <select class="form-select" name="priority">
                            <option value="low" ${task && task.priority === 'low' ? 'selected' : ''}>Basse</option>
                            <option value="medium" ${task && task.priority === 'medium' ? 'selected' : ''}>Normale</option>
                            <option value="high" ${task && task.priority === 'high' ? 'selected' : ''}>√âlev√©e</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">√âch√©ance</label>
                        <input type="date" class="form-input" name="deadline" value="${task ? task.deadline || '' : ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Temps estim√© (heures)</label>
                        <input type="number" class="form-input" name="estimatedTime" min="0.5" step="0.5" value="${task ? task.estimatedTime || '' : ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Statut</label>
                        <select class="form-select" name="status" onchange="app.toggleDelegatedField(this.value)">
                            ${Object.entries(this.statusConfig).map(([k, v]) => 
                                `<option value="${k}" ${task && task.status === k ? 'selected' : ''}>${v.label}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group" id="delegated-group" style="display: ${task && task.status === 'delegated' ? 'block' : 'none'}">
                        <label class="form-label">D√©l√©gu√© √†</label>
                        <input type="text" class="form-input" name="delegatedTo" value="${task ? task.delegatedTo || '' : ''}">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" data-close="task-modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">${isEdit ? 'Mettre √† jour' : 'Cr√©er'}</button>
                    </div>
                </form>
            </div>
        `;
        
        this.openModal('task-modal');
    }
    
    async saveTask(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData);
        
        const taskData = {
            title: data.title,
            description: data.description,
            category: data.category,
            priority: data.priority,
            status: data.status,
            deadline: data.deadline,
            estimatedTime: parseFloat(data.estimatedTime) || 0,
            delegatedTo: data.delegatedTo,
            space: this.currentSpace,
            createdAt: this.editingTaskId ? 
                (this.tasks.find(t => t.id === this.editingTaskId)?.createdAt || new Date().toISOString()) : 
                new Date().toISOString()
        };
        
        if (taskData.status === 'done') {
            taskData.completedAt = taskData.completedAt || new Date().toISOString();
        }
        
        if (this.editingTaskId) {
            taskData.id = this.editingTaskId;
        }
        
        await this.saveTaskToFirebase(taskData);
        
        this.closeModal('task-modal');
        this.showNotification(this.editingTaskId ? 'T√¢che mise √† jour' : 'T√¢che cr√©√©e', 'success');
        this.editingTaskId = null;
    }
    
    showDelegateModal() {
        const modal = document.getElementById('delegate-modal');
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">D√©l√©guer la t√¢che</h2>
                    <button class="close-btn" data-close="delegate-modal">√ó</button>
                </div>
                <form id="delegate-form" onsubmit="app.saveDelegate(event)">
                    <div class="form-group">
                        <label class="form-label">D√©l√©guer √† *</label>
                        <input type="text" class="form-input" name="delegatedTo" required placeholder="Nom de la personne">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date de relance</label>
                        <input type="date" class="form-input" name="reminder">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" data-close="delegate-modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">D√©l√©guer</button>
                    </div>
                </form>
            </div>
        `;
        
        this.openModal('delegate-modal');
    }
    
    async saveDelegate(event) {
        event.preventDefault();
        if (!this.delegatingTaskId) return;
        
        const formData = new FormData(event.target);
        const task = this.tasks.find(t => t.id === this.delegatingTaskId);
        
        if (task) {
            task.delegatedTo = formData.get('delegatedTo');
            task.delegateReminder = formData.get('reminder');
            task.status = 'delegated';
            
            await this.saveTaskToFirebase(task);
            
            this.closeModal('delegate-modal');
            this.showNotification('T√¢che d√©l√©gu√©e', 'success');
        }
        
        this.delegatingTaskId = null;
    }
    
    toggleDelegatedField(status) {
        document.getElementById('delegated-group').style.display = 
            status === 'delegated' ? 'block' : 'none';
    }
    
    // Reconnaissance vocale am√©lior√©e
    processVoiceCommand(text) {
        console.log('Commande vocale re√ßue:', text);
        const lower = text.toLowerCase();
        
        // Extraction intelligente des informations
        const task = {
            title: this.extractTitle(text),
            description: '',
            category: this.parseCategory(lower),
            priority: this.parsePriority(lower),
            status: 'todo',
            deadline: this.parseDeadline(lower),
            estimatedTime: this.parseTime(lower),
            delegatedTo: this.parseDelegation(lower),
            space: this.currentSpace,
            createdAt: new Date().toISOString()
        };
        
        // Si d√©l√©gation d√©tect√©e, mettre le statut appropri√©
        if (task.delegatedTo) {
            task.status = 'delegated';
        }
        
        this.saveTaskToFirebase(task);
        this.showNotification(`T√¢che ajout√©e: ${task.title}`, 'success');
    }
    
    extractTitle(text) {
        // Retirer les mots-cl√©s de contexte pour garder l'essentiel
        let title = text;
        
        // Patterns √† retirer
        const patterns = [
            /^(ajoute|ajouter|cr√©er|cr√©e|nouvelle t√¢che|t√¢che)/i,
            /(urgent|urgente|importante?|priorit√©|prioritaire)/i,
            /(pour demain|pour apr√®s-demain|avant|deadline)/i,
            /(d√©l√©guer √†|d√©l√©gu√© √†|pour|assigner √†)/i,
            /(m√©thode|qualit√©|maintenance)/i,
            /(qui prend|qui dure|dur√©e|temps|heures?|jours?)/i
        ];
        
        // Nettoyer le titre mais garder les mots importants apr√®s les mots-cl√©s
        let cleanTitle = title;
        
        // Si la phrase commence par "ajoute/cr√©er/etc", retirer ce d√©but
        if (/^(ajoute|ajouter|cr√©er|cr√©e|nouvelle t√¢che|t√¢che)/i.test(cleanTitle)) {
            cleanTitle = cleanTitle.replace(/^(ajoute|ajouter|cr√©er|cr√©e|nouvelle t√¢che|t√¢che):?\s*/i, '');
        }
        
        // Capitaliser la premi√®re lettre
        return cleanTitle.charAt(0).toUpperCase() + cleanTitle.slice(1);
    }
    
    parseCategory(text) {
        // Recherche plus flexible des cat√©gories
        if (/m√©thod|process|proc√©d/i.test(text)) return 'method';
        if (/qualit√©|contr√¥le|audit|norme/i.test(text)) return 'quality';
        if (/mainten|r√©para|entretien|SAV/i.test(text)) return 'maintenance';
        
        // Cat√©gories bas√©es sur des mots-cl√©s contextuels
        if (/r√©union|meeting|rendez-vous|appel/i.test(text)) return 'method';
        if (/rapport|document|r√©vision|mise √† jour/i.test(text)) return 'quality';
        if (/v√©rif|check|test|diagnostic/i.test(text)) return 'maintenance';
        
        return 'other';
    }
    
    parsePriority(text) {
        // D√©tection am√©lior√©e de la priorit√©
        if (/tr√®s urgent|urgentissime|critique|asap|tout de suite/i.test(text)) return 'high';
        if (/urgent|important|priorit/i.test(text)) return 'high';
        if (/normal|moyen|standard/i.test(text)) return 'medium';
        if (/basse?|faible|peut attendre|pas urgent|tranquille/i.test(text)) return 'low';
        
        // Par d√©faut, si une deadline proche est mentionn√©e
        if (/aujourd'hui|ce soir|maintenant/i.test(text)) return 'high';
        if (/demain|domain/i.test(text)) return 'medium';
        
        return 'medium';
    }
    
    parseDeadline(text) {
        const date = new Date();
        
        // Dates relatives
        if (/aujourd'hui|ce soir|fin de journ√©e/i.test(text)) {
            return date.toISOString().split('T')[0];
        }
        if (/demain|domain/i.test(text)) {
            date.setDate(date.getDate() + 1);
            return date.toISOString().split('T')[0];
        }
        if (/apr√®s[- ]demain/i.test(text)) {
            date.setDate(date.getDate() + 2);
            return date.toISOString().split('T')[0];
        }
        
        // Jours de la semaine
        const jours = {
            'lundi': 1, 'mardi': 2, 'mercredi': 3, 
            'jeudi': 4, 'vendredi': 5, 'samedi': 6, 'dimanche': 0
        };
        
        for (const [jour, num] of Object.entries(jours)) {
            if (text.includes(jour)) {
                const currentDay = date.getDay();
                let daysToAdd = num - currentDay;
                if (daysToAdd <= 0) daysToAdd += 7; // Semaine prochaine
                date.setDate(date.getDate() + daysToAdd);
                return date.toISOString().split('T')[0];
            }
        }
        
        // D√©tection "dans X jours"
        const dansXJours = text.match(/dans (\d+) jours?/i);
        if (dansXJours) {
            date.setDate(date.getDate() + parseInt(dansXJours[1]));
            return date.toISOString().split('T')[0];
        }
        
        // D√©tection "avant le X"
        const avantLe = text.match(/avant le (\d{1,2})/i);
        if (avantLe) {
            const jour = parseInt(avantLe[1]);
            date.setDate(jour);
            if (date < new Date()) {
                date.setMonth(date.getMonth() + 1);
            }
            return date.toISOString().split('T')[0];
        }
        
        return null;
    }
    
    parseTime(text) {
        // Extraction du temps estim√©
        const patterns = [
            /(\d+)\s*h(?:eure)?s?/i,
            /(\d+)\s*minute?s?/i,
            /(\d+)\s*jour?s?/i,
            /qui (?:prend|dure|prendra)\s*(\d+)/i
        ];
        
        for (const pattern of patterns) {
            const match = text.match(pattern);
            if (match) {
                const value = parseInt(match[1]);
                if (pattern.toString().includes('minute')) {
                    return Math.round(value / 60 * 10) / 10; // Convertir en heures
                }
                if (pattern.toString().includes('jour')) {
                    return value * 8; // Consid√©rer 8h par jour
                }
                return value;
            }
        }
        
        // Estimations bas√©es sur des mots-cl√©s
        if (/rapide|vite|court|petit/i.test(text)) return 0.5;
        if (/long|longue|complexe|gros|grosse/i.test(text)) return 4;
        
        return 1; // Par d√©faut
    }
    
    parseDelegation(text) {
        // Patterns pour d√©tecter la d√©l√©gation
        const patterns = [
            /(?:d√©l√©guer?|d√©l√©gu√©|assigner?|assign√©|donner?) (?:√†|a) (\w+)/i,
            /pour (\w+)$/i,
            /(?:que|demander √†) (\w+) (?:de|d')/i,
            /(\w+) (?:doit|devra|va)/i
        ];
        
        for (const pattern of patterns) {
            const match = text.match(pattern);
            if (match && match[1]) {
                // Capitaliser le nom
                const nom = match[1];
                return nom.charAt(0).toUpperCase() + nom.slice(1).toLowerCase();
            }
        }
        
        return null;
    }
    
    // Autres m√©thodes utilitaires...
    
    getFilteredTasks() {
        const category = document.getElementById('category-filter').value;
        const priority = document.getElementById('priority-filter').value;
        const search = document.getElementById('search-filter').value.toLowerCase();
        
        return this.tasks.filter(task => {
            if (task.space !== this.currentSpace) return false;
            if (category && task.category !== category) return false;
            if (priority && task.priority !== priority) return false;
            if (search && !task.title.toLowerCase().includes(search)) return false;
            return true;
        });
    }
    
    calculateStats() {
        const filtered = this.getFilteredTasks();
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        
        return {
            total: filtered.length,
            todo: filtered.filter(t => t.status === 'todo').length,
            inProgress: filtered.filter(t => t.status === 'in-progress').length,
            done: filtered.filter(t => 
                t.status === 'done' && new Date(t.completedAt) > weekAgo
            ).length
        };
    }
    
    switchSpace(space) {
        this.currentSpace = space;
        localStorage.setItem('currentSpace', space);
        document.querySelectorAll('.space-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.space === space);
        });
        this.render();
    }
    
    showKPIModal() {
        const modal = document.getElementById('kpi-modal');
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Indicateurs de Performance</h2>
                    <button class="close-btn" data-close="kpi-modal">√ó</button>
                </div>
                <div id="kpi-content">
                    <div class="kpi-period-selector">
                        <button class="btn btn-primary" data-period="week">Semaine</button>
                        <button class="btn btn-secondary" data-period="month">Mois</button>
                        <button class="btn btn-secondary" data-period="year">Ann√©e</button>
                    </div>
                    <div id="kpi-stats"></div>
                </div>
            </div>
        `;
        
        this.openModal('kpi-modal');
        this.showKPIPeriod('week');
    }
    
    showKPIPeriod(period) {
        // Mettre √† jour les boutons
        document.querySelectorAll('[data-period]').forEach(btn => {
            btn.className = btn.dataset.period === period ? 'btn btn-primary' : 'btn btn-secondary';
        });
        
        const stats = this.calculateKPIStats(period);
        
        document.getElementById('kpi-stats').innerHTML = `
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value">${stats.created}</div>
                    <div class="kpi-label">T√¢ches cr√©√©es</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${stats.completed}</div>
                    <div class="kpi-label">T√¢ches termin√©es</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${stats.inProgress}</div>
                    <div class="kpi-label">En cours</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${stats.delegated}</div>
                    <div class="kpi-label">D√©l√©gu√©es</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${stats.completionRate}%</div>
                    <div class="kpi-label">Taux de compl√©tion</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value">${stats.avgTime}h</div>
                    <div class="kpi-label">Temps moyen/t√¢che</div>
                </div>
            </div>
            <div class="kpi-chart">
                <h3>R√©partition par cat√©gorie</h3>
                <div style="display: flex; justify-content: space-around; margin-top: 1rem;">
                    ${Object.entries(stats.byCategory).map(([cat, count]) => `
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; color: var(--p);">${count}</div>
                            <div style="color: var(--gray); font-size: 0.875rem;">${this.categories[cat] || cat}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    calculateKPIStats(period) {
        const now = new Date();
        let startDate = new Date();
        
        switch(period) {
            case 'week':
                startDate.setDate(now.getDate() - now.getDay());
                break;
            case 'month':
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                break;
            case 'year':
                startDate = new Date(now.getFullYear(), 0, 1);
                break;
        }
        startDate.setHours(0, 0, 0, 0);
        
        const spaceTasks = this.tasks.filter(t => t.space === this.currentSpace);
        const periodTasks = spaceTasks.filter(t => new Date(t.createdAt) >= startDate);
        const completedTasks = periodTasks.filter(t => t.status === 'done');
        
        const totalTime = completedTasks.reduce((sum, t) => sum + (t.estimatedTime || 0), 0);
        const byCategory = {};
        
        periodTasks.forEach(t => {
            byCategory[t.category] = (byCategory[t.category] || 0) + 1;
        });
        
        return {
            created: periodTasks.length,
            completed: completedTasks.length,
            inProgress: periodTasks.filter(t => t.status === 'in-progress').length,
            delegated: periodTasks.filter(t => t.status === 'delegated').length,
            completionRate: periodTasks.length ? Math.round((completedTasks.length / periodTasks.length) * 100) : 0,
            avgTime: completedTasks.length ? (totalTime / completedTasks.length).toFixed(1) : 0,
            byCategory
        };
    }
    
    exportTasks() {
        const tasks = this.tasks.filter(t => t.space === this.currentSpace);
        const headers = ['Titre', 'Description', 'Cat√©gorie', 'Priorit√©', 'Statut', '√âch√©ance', 'Temps estim√©', 'D√©l√©gu√© √†'];
        const rows = tasks.map(t => [
            t.title,
            t.description || '',
            this.categories[t.category],
            t.priority,
            t.status,
            t.deadline ? this.formatDate(t.deadline) : '',
            t.estimatedTime || '',
            t.delegatedTo || ''
        ]);
        
        const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tasks_${this.currentSpace}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        this.showNotification('Export r√©ussi', 'success');
    }
    
    setupSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window)) return;
        
        this.recognition = new webkitSpeechRecognition();
        this.recognition.lang = 'fr-FR';
        this.recognition.continuous = false;
        this.recognition.interimResults = false;
        
        this.recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            this.processVoiceCommand(transcript);
        };
        
        this.recognition.onerror = () => {
            this.showNotification('Erreur de reconnaissance vocale', 'error');
            document.querySelector('.voice-btn').classList.remove('recording');
        };
        
        this.recognition.onend = () => {
            document.querySelector('.voice-btn').classList.remove('recording');
        };
    }
    
    toggleVoiceRecording() {
        const btn = document.querySelector('.voice-btn');
        
        if (btn.classList.contains('recording')) {
            this.recognition.stop();
        } else {
            btn.classList.add('recording');
            this.recognition.start();
            this.showNotification('Parlez maintenant...', 'success');
        }
    }
    
    startPeriodicChecks() {
        setInterval(() => this.checkDeadlines(), 60000);
        this.checkDeadlines();
    }
    
    checkDeadlines() {
        const now = new Date();
        this.tasks.forEach(task => {
            if (task.deadline && task.status !== 'done') {
                const daysUntil = this.getDaysUntilDeadline(task.deadline);
                
                if (task.priority === 'high' && [5, 3, 1].includes(daysUntil)) {
                    this.showNotification(`Rappel: "${task.title}" dans ${daysUntil} jours`, 'warning');
                } else if (daysUntil === 1) {
                    this.showNotification(`Rappel: "${task.title}" demain`, 'warning');
                }
            }
        });
    }
    
    // UI Helpers
    openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }
    
    closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('active');
        
        // R√©initialiser les √©tats
        if (modalId === 'task-modal') {
            this.editingTaskId = null;
        } else if (modalId === 'delegate-modal') {
            this.delegatingTaskId = null;
        }
    }
    
    showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        clearTimeout(this.notificationTimeout);
        this.notificationTimeout = setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    toggleTheme() {
        this.darkMode = !this.darkMode;
        document.body.classList.toggle('dark');
        localStorage.setItem('darkMode', this.darkMode);
        document.querySelector('[data-action="theme"]').textContent = this.darkMode ? '‚òÄÔ∏è' : 'üåô';
    }
    
    applyTheme() {
        if (this.darkMode) {
            document.body.classList.add('dark');
            document.querySelector('[data-action="theme"]').textContent = '‚òÄÔ∏è';
        }
    }
    
    // Date utilities
    formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('fr-FR');
    }
    
    getDaysUntilDeadline(deadline) {
        return Math.ceil((new Date(deadline) - new Date()) / (1000 * 60 * 60 * 24));
    }
    
    getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    debounce(func, wait) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
    
    // Cleanup on page unload
    destroy() {
        if (this.unsubscribe) {
            this.unsubscribe();
        }
    }
}

// Initialisation
const app = new TaskFlowFirebase();

// Rendre l'app globale pour les √©v√©nements inline
window.app = app;

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    app.destroy();
});

// Service Worker pour PWA
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
}
</script>
</body>
</html>